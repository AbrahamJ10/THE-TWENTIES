<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Productos - THE TWENTIES</title>
  <link rel="stylesheet" href="productos.css">
  <link rel="icon" href="https://raw.githubusercontent.com/AbrahamJ10/imagenes_the_t/main/logo.jpg">
</head>
<body>

  <!-- ===== ENCABEZADO ===== -->
  <header>
    <div class="logo">
      <img src="https://raw.githubusercontent.com/AbrahamJ10/imagenes_the_t/main/logo.jpg" alt="Logo de la empresa">
      <h1>THE TWENTIES</h1>
    </div>

    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="productos.html" class="activo">Productos</a></li>
        <li><a href="contacto.html">Contacto</a></li>
        <li><a href="login.html">Login</a></li>
      </ul>
    </nav>
  </header>

  <!-- ===== SECCI√ìN PRODUCTOS ===== -->
  <section id="productos" class="nueva-coleccion">
    <div class="filtros">
      <div class="filtro-izquierda">
        <select id="filtroCategoria">
          <option value="">Todas las categor√≠as</option>
        </select>

        <!-- üîπ Nuevo select para subcategor√≠as -->
        <select id="filtroSubcategoria">
          <option value="">Todas las subcategor√≠as</option>
        </select>
      </div>

      <div class="filtro-derecha">
        <input type="text" id="buscador" placeholder="üîç Buscar por nombre o descripci√≥n">
      </div>
    </div>

    <div class="grid-coleccion" id="listaProductos"></div>
  </section>

  <script>
    async function cargarProductos() {
      try {
        const res = await fetch("/api/almacen");
        const productos = await res.json();

        const contenedor = document.getElementById("listaProductos");
        const selectCategoria = document.getElementById("filtroCategoria");
        const selectSubcategoria = document.getElementById("filtroSubcategoria");
        const buscador = document.getElementById("buscador");

        // üîπ Obtener categor√≠as √∫nicas
        const categorias = [...new Set(productos.map(p => p.categoria).filter(c => c))];
        categorias.forEach(cat => {
          const option = document.createElement("option");
          option.value = cat;
          option.textContent = cat;
          selectCategoria.appendChild(option);
        });

        // üîπ Actualizar subcategor√≠as seg√∫n categor√≠a
        function actualizarSubcategorias(categoria) {
          selectSubcategoria.innerHTML = "<option value=''>Todas las subcategor√≠as</option>";

          const subcategorias = [
            ...new Set(
              productos
                .filter(p => !categoria || p.categoria === categoria)
                .map(p => p.subcategoria)
                .filter(sc => sc)
            )
          ];

          subcategorias.forEach(sc => {
            const option = document.createElement("option");
            option.value = sc;
            option.textContent = sc;
            selectSubcategoria.appendChild(option);
          });
        }

        // üîπ Mostrar productos
        function mostrarProductos(filtroCat = "", filtroSub = "", texto = "") {
          contenedor.innerHTML = "";
          const filtrados = productos.filter(p => {
            const coincideCat = filtroCat ? p.categoria === filtroCat : true;
            const coincideSub = filtroSub ? p.subcategoria === filtroSub : true;
            const coincideTexto = texto
              ? p.nombre.toLowerCase().includes(texto.toLowerCase()) ||
                p.descripcion.toLowerCase().includes(texto.toLowerCase())
              : true;
            return coincideCat && coincideSub && coincideTexto;
          });

          if (filtrados.length === 0) {
            contenedor.innerHTML = "<p>No se encontraron productos.</p>";
            return;
          }

          filtrados.forEach(p => {
            const item = document.createElement("div");
            item.classList.add("item");
            item.innerHTML = `
              <img src="${p.imagen_ruta || 'https://via.placeholder.com/200'}" alt="${p.nombre}">
              <div class="info">
                <h3>${p.nombre}</h3>
                <p>${p.descripcion || ""}</p>
                <p class="precio">S/ ${p.costo || 0}</p>
                <button>LO QUIERO...</button>
              </div>
            `;
            contenedor.appendChild(item);
          });
        }

        // üîπ Eventos de cambio
        selectCategoria.addEventListener("change", () => {
          actualizarSubcategorias(selectCategoria.value);
          mostrarProductos(selectCategoria.value, selectSubcategoria.value, buscador.value);
        });

        selectSubcategoria.addEventListener("change", () => {
          mostrarProductos(selectCategoria.value, selectSubcategoria.value, buscador.value);
        });

        buscador.addEventListener("input", () => {
          mostrarProductos(selectCategoria.value, selectSubcategoria.value, buscador.value);
        });

        // üîπ Inicializar vista
        actualizarSubcategorias("");
        mostrarProductos();

      } catch (error) {
        console.error("Error al cargar productos:", error);
      }
    }

    document.addEventListener("DOMContentLoaded", cargarProductos);
  </script>

</body>
</html>
